<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NISA vs ç‰¹å®šå£åº§ å–ã‚Šå´©ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
<style>
  :root { --pico-font-size: 16px; }
  .grid { display: grid; gap: 1rem; }
  @media(min-width: 1000px){ .grid-2 {grid-template-columns: minmax(280px, 400px) 1fr;} }
  .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, Consolas, monospace; }
  canvas { max-height: 360px; }
  body { margin: 0 !important; }
</style>
</head>
<body>
<main style="padding: 1.5rem;">
  <h1>NISA â‡„ ç‰¹å®šå£åº§ å–ã‚Šå´©ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

  <div class="grid grid-2">
    <!-- å…¥åŠ› -->
    <section>
      <form id="form">
        <fieldset>
          <legend>NISAå£åº§</legend>
          <label>è³‡ç”£ï¼ˆä¸‡å††ï¼‰<input type="number" id="nisaValue" value="300" step="10"></label>
          <label>å¹´é–“æƒ³å®šãƒªã‚¿ãƒ¼ãƒ³ï¼ˆ%ï¼‰<input type="number" id="nisaReturn" value="5" step="0.1"></label>
        </fieldset>

        <fieldset>
          <legend>ç‰¹å®šå£åº§</legend>
          <label>è³‡ç”£ï¼ˆä¸‡å††ï¼‰<input type="number" id="taxValue" value="300" step="10"></label>
          <label>è©•ä¾¡æç›Šç‡ï¼ˆ%ï¼‰â€»å–ã‚Šå´©ã—é–‹å§‹æ™‚ç‚¹ <input type="number" id="taxGainPct" value="50" step="1"></label>
          <label>å¹´é–“æƒ³å®šãƒªã‚¿ãƒ¼ãƒ³ï¼ˆ%ï¼‰<input type="number" id="taxReturn" value="5" step="0.1"></label>
        </fieldset>

        <label>å–ã‚Šå´©ã—é¡ï¼ˆä¸‡å††/å¹´ï¼‰â€»ç¨é‡‘ã‚’å·®ã—å¼•ã„ãŸé¡ã‚’å…¥åŠ›
          <input type="number" id="withdraw" value="30" step="1">
        </label>

        <fieldset>
          <legend>å–ã‚Šå´©ã—å„ªå…ˆé †ä½</legend>
          <label><input type="radio" name="priority" value="taxable_first" checked> ç‰¹å®šå£åº§ã‹ã‚‰å„ªå…ˆã—ã¦å–ã‚Šå´©ã—</label>
          <label><input type="radio" name="priority" value="nisa_first"> NISAã‹ã‚‰å„ªå…ˆã—ã¦å–ã‚Šå´©ã—</label>
        </fieldset>

        <label>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¹´æ•°
          <input type="number" id="years" value="50" min="1" step="1">
        </label>

        <button type="submit">è¨ˆç®—ã™ã‚‹</button>
      </form>
    </section>

    <!-- å‡ºåŠ› -->
    <section>
      <h3>æ®‹é«˜æ¨ç§»ï¼ˆåˆè¨ˆï¼‰</h3>
      <canvas id="chart"></canvas>
      <h3>å¹´æ¬¡å†…è¨³</h3>
      <table id="resultTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const TAX_RATE = 0.20315;

function toBasis(value, gainPct){
  return value*10000 / (1+gainPct/100);
}

function simulate({nisaV,nisaR,taxV,taxB,taxR,withdraw,years,priority}){
  const rows=[];
  for(let y=1;y<=years;y++){
    nisaV *= (1+nisaR);
    taxV  *= (1+taxR);

    let need=withdraw, taxPaid=0, handTaken=0;

    if(priority==="nisa_first"){
      const take=Math.min(nisaV,need);
      nisaV-=take; need-=take; handTaken+=take;
    }
    if(need>0 && taxV>0){
      const gainRatio=(taxV-taxB)/taxV;
      const takeRate=1-TAX_RATE*gainRatio;
      let gross=need/takeRate;
      if(gross>taxV) gross=taxV;
      const realizedGain=gross*gainRatio;
      const tax=realizedGain*TAX_RATE;
      const net=gross-tax;
      if(taxV>0){
        const basisReduction = taxB * (gross/taxV);
        taxV-=gross; taxB-=basisReduction;
      }
      need-=net; taxPaid+=tax; handTaken+=net;
    }
    if(priority==="taxable_first" && need>0){
      const take=Math.min(nisaV,need);
      nisaV-=take; need-=take; handTaken+=take;
    }

    rows.push({year:y,nisa:nisaV,tax:taxV,total:nisaV+taxV,hand:handTaken,taxPaid:taxPaid});
  }
  return rows;
}

const form=document.getElementById('form');
const tableHead=document.querySelector('#resultTable thead');
const tableBody=document.querySelector('#resultTable tbody');
let chart;

form.addEventListener('submit',(e)=>{
  e.preventDefault();
  const nisaVal=Number(document.getElementById('nisaValue').value);
  const nisaR=Number(document.getElementById('nisaReturn').value)/100;
  const taxVal=Number(document.getElementById('taxValue').value);
  const taxGain=Number(document.getElementById('taxGainPct').value);
  const taxR=Number(document.getElementById('taxReturn').value)/100;
  const withdraw=Number(document.getElementById('withdraw').value)*10000;
  const years=Number(document.getElementById('years').value);
  const priority=[...document.querySelectorAll('input[name="priority"]')].find(r=>r.checked).value;

  let nisaAsset=nisaVal*10000;
  let taxAsset=taxVal*10000;
  let taxBasis=toBasis(taxVal,taxGain);

  // ä¸¡æ–¹è¨ˆç®—
  const rowsN=simulate({nisaV:nisaAsset,nisaR,taxV:taxAsset,taxB:taxBasis,taxR,withdraw,years,priority:"nisa_first"});
  const rowsT=simulate({nisaV:nisaAsset,nisaR,taxV:taxAsset,taxB:taxBasis,taxR,withdraw,years,priority:"taxable_first"});
  const rows = (priority==="nisa_first") ? rowsN : rowsT;  // ğŸ”¹ã“ã“ã‚’è¿½åŠ 

  // ã‚°ãƒ©ãƒ•
  const labels=rows.map(r=>`${r.year}å¹´`);
  if(chart) chart.destroy();

  let selectedDataset, otherDataset;
  if(priority==="nisa_first"){
    selectedDataset = {label:"NISAå„ªå…ˆ", data:rowsN.map(r=>r.total), borderColor:"blue", backgroundColor:"blue", tension:.2};
    otherDataset    = {label:"ç‰¹å®šå„ªå…ˆ", data:rowsT.map(r=>r.total), borderColor:"red", backgroundColor:"red", tension:.2};
  } else {
    selectedDataset = {label:"ç‰¹å®šå„ªå…ˆ", data:rowsT.map(r=>r.total), borderColor:"blue", backgroundColor:"blue", tension:.2};
    otherDataset    = {label:"NISAå„ªå…ˆ", data:rowsN.map(r=>r.total), borderColor:"red", backgroundColor:"red", tension:.2};
  }

  chart=new Chart(document.getElementById('chart'),{
    type:'line',
    data:{ labels, datasets:[selectedDataset, otherDataset] },
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // è¡¨
  tableHead.innerHTML=`<tr>
    <th>å¹´</th><th>NISAæ®‹é«˜</th><th>ç‰¹å®šæ®‹é«˜</th><th>åˆè¨ˆ</th><th>å–ã‚Šå´©ã—é¡ï¼»æ‰‹å–ã‚Šï¼½</th><th>ç¨é‡‘</th>
  </tr>`;
  tableBody.innerHTML=rows.map(r=>`
    <tr>
      <td class="mono">${r.year}</td>
      <td class="mono">${Math.round(r.nisa).toLocaleString()}</td>
      <td class="mono">${Math.round(r.tax).toLocaleString()}</td>
      <td class="mono"><b>${Math.round(r.total).toLocaleString()}</b></td>
      <td class="mono">${Math.round(r.hand).toLocaleString()}</td>
      <td class="mono">${Math.round(r.taxPaid).toLocaleString()}</td>
    </tr>`).join('');
});
</script>
</body>
</html>
